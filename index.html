<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ä»£ç çŸ¥è¯†æ²‰æ·€å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
            position: relative;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            font-weight: bold;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .result.active {
            display: block;
        }

        .result h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .issue-card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .issue-card.high {
            border-left-color: #e74c3c;
        }

        .issue-card.medium {
            border-left-color: #f39c12;
        }

        .issue-card.low {
            border-left-color: #3498db;
        }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .issue-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .issue-type.security {
            background: #fee;
            color: #c33;
        }

        .issue-type.performance {
            background: #ffeaa7;
            color: #d63031;
        }

        .issue-type.style {
            background: #dfe6e9;
            color: #2d3436;
        }

        .issue-type.best_practice {
            background: #d5f4e6;
            color: #00b894;
        }

        .severity-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .severity-badge.high {
            background: #e74c3c;
            color: white;
        }

        .severity-badge.medium {
            background: #f39c12;
            color: white;
        }

        .severity-badge.low {
            background: #3498db;
            color: white;
        }

        .related-cases {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4f8;
            border-radius: 8px;
        }

        .related-cases h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .case-item {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            font-size: 14px;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            flex: 1;
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .knowledge-list {
            display: grid;
            gap: 15px;
        }

        .knowledge-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .knowledge-item h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .knowledge-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .knowledge-controls input,
        .knowledge-controls select {
            padding: 10px 12px;
            border: 1px solid #e4e7ec;
            border-radius: 6px;
            min-width: 200px;
        }

        .tag-chip {
            display: inline-block;
            padding: 2px 8px;
            background: #e8f4f8;
            color: #0b7285;
            border-radius: 999px;
            font-size: 12px;
            margin-right: 6px;
            margin-top: 6px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-draft {
            background: #fef9c3;
            color: #ca8a04;
        }

        .status-pending_review {
            background: #fde8f3;
            color: #c026d3;
        }

        .status-published {
            background: #dcfce7;
            color: #15803d;
        }

        .knowledge-actions {
            margin-top: 12px;
            display: flex;
            gap: 10px;
        }

        .knowledge-actions button {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 13px;
            padding: 0;
        }

        .knowledge-actions button.danger {
            color: #e74c3c;
        }

        .knowledge-actions button:disabled {
            color: #aaa;
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e4e7ec;
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-bar .progress {
            height: 100%;
            background: #667eea;
            border-radius: 999px;
        }

        .graph-container {
            position: relative;
            background: #ffffff;
            border: 1px solid #e4e7ec;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            min-height: 280px;
            overflow: hidden;
        }

        .graph-columns {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 20px;
            position: relative;
            z-index: 2;
        }

        .graph-column h4 {
            margin-bottom: 10px;
            color: #0f172a;
        }

        .graph-nodes {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .graph-node {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 13px;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.1);
        }

        .graph-node .title {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .graph-node .meta {
            font-size: 12px;
            color: #64748b;
        }

        .graph-node-code_file {
            border-left: 3px solid #38bdf8;
        }

        .graph-node-review_comment {
            border-left: 3px solid #f97316;
        }

        .graph-node-knowledge {
            border-left: 3px solid #22c55e;
        }

        #graph-edges {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        #graph-empty {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 60px;
            z-index: 999;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .ast-tree {
            margin-top: 12px;
            border-top: 1px dashed #b6d7e5;
            padding-top: 10px;
        }

        .ast-tree details {
            margin-bottom: 8px;
            background: #fff;
            border-radius: 6px;
            padding: 4px 8px;
        }

        .ast-tree summary {
            font-weight: 600;
            cursor: pointer;
        }

        .ast-tree ul {
            margin: 6px 0 0 18px;
            padding: 0;
        }

        .ast-tree li {
            list-style: disc;
            color: #0f172a;
            font-size: 13px;
            line-height: 1.5;
        }

        .knowledge-item .category {
            display: inline-block;
            padding: 4px 12px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .user-info span {
            font-size: 14px;
        }

        .logout-btn {
            padding: 6px 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .admin-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #f39c12;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login-container" class="login-container" style="display: none;">
        <h2 style="text-align: center; margin-bottom: 30px; color: #667eea;">æ™ºèƒ½ä»£ç çŸ¥è¯†æ²‰æ·€å¹³å°</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="login-username">ç”¨æˆ·å</label>
                <input type="text" id="login-username" name="username" required autocomplete="username">
            </div>
            <div class="form-group">
                <label for="login-password">å¯†ç </label>
                <input type="password" id="login-password" name="password" required autocomplete="current-password">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">ç™»å½•</button>
        </form>
        <p style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
            <strong>é»˜è®¤è´¦å·:</strong> root<br>
            <strong>é»˜è®¤å¯†ç :</strong> 123456
        </p>
        <p style="text-align: center; margin-top: 10px; color: #e74c3c; font-size: 12px;">
        </p>
        <p style="text-align: center; margin-top: 10px;">
            <a href="#" onclick="showRegister(); return false;" style="color: #667eea; text-decoration: none;">æ³¨å†Œæ–°è´¦å·</a>
        </p>
    </div>

    <!-- æ³¨å†Œç•Œé¢ -->
    <div id="register-container" class="login-container" style="display: none;">
        <h2 style="text-align: center; margin-bottom: 30px; color: #667eea;">ç”¨æˆ·æ³¨å†Œ</h2>
        <form id="register-form">
            <div class="form-group">
                <label for="register-username">ç”¨æˆ·å</label>
                <input type="text" id="register-username" name="username" required>
            </div>
            <div class="form-group">
                <label for="register-password">å¯†ç </label>
                <input type="password" id="register-password" name="password" required>
            </div>
            <div class="form-group">
                <label for="register-email">é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                <input type="email" id="register-email" name="email">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">æ³¨å†Œ</button>
        </form>
        <p style="text-align: center; margin-top: 20px;">
            <a href="#" onclick="showLogin(); return false;" style="color: #667eea; text-decoration: none;">è¿”å›ç™»å½•</a>
        </p>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="main-container" style="display: none;">
    <div class="container">
        <div class="header">
            <h1>æ™ºèƒ½ä»£ç çŸ¥è¯†æ²‰æ·€å¹³å°</h1>
            <p>åŸºäºAIçš„ä»£ç å®¡æŸ¥ä¸çŸ¥è¯†ç®¡ç†</p>
            <div class="user-info" id="user-info">
                <span>æ¬¢è¿, <strong id="current-username"></strong><span id="user-role-badge"></span></span>
                <button class="logout-btn" onclick="logout()">é€€å‡º</button>
            </div>
        </div>

        <div class="content">
            <div class="tabs">
                <button type="button" class="tab active" data-tab="review">ä»£ç å®¡æŸ¥</button>
                <button type="button" class="tab" data-tab="history">æŸ¥çœ‹å†å²</button>
                <button type="button" class="tab" data-tab="knowledge">çŸ¥è¯†åº“</button>
                <button type="button" class="tab" data-tab="dashboard">æ•°æ®çœ‹æ¿</button>
            </div>

            <!-- ä»£ç å®¡æŸ¥æ ‡ç­¾é¡µ -->
            <div id="review-tab" class="tab-content active">
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="switchUploadMode('paste')" id="mode-paste-btn" style="flex: 1; padding: 12px;">ğŸ“ ç²˜è´´ä»£ç </button>
                    <button class="btn" onclick="switchUploadMode('upload')" id="mode-upload-btn" style="flex: 1; padding: 12px; background: #f8f9fa; border: 1px solid #dee2e6;">ğŸ“ ä¸Šä¼ æ–‡ä»¶</button>
                </div>
                
                <!-- ç²˜è´´ä»£ç æ¨¡å¼ -->
                <div id="paste-mode">
                    <form id="review-form">
                        <div class="form-group">
                            <label for="file-name">æ–‡ä»¶å</label>
                            <input type="text" id="file-name" name="file_name" value="code.py" required>
                        </div>

                        <div class="form-group">
                            <label for="language">ç¼–ç¨‹è¯­è¨€</label>
                            <select id="language" name="language">
                                <option value="python">Python</option>
                                <option value="javascript">JavaScript</option>
                                <option value="java">Java</option>
                                <option value="go">Go</option>
                                <option value="cpp">C++</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="code">ä»£ç å†…å®¹</label>
                            <textarea id="code" name="code" placeholder="è¯·ç²˜è´´æˆ–è¾“å…¥è¦å®¡æŸ¥çš„ä»£ç ..." required></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary" id="review-btn">å¼€å§‹å®¡æŸ¥</button>
                    </form>
                </div>
                
                <!-- æ–‡ä»¶ä¸Šä¼ æ¨¡å¼ -->
                <div id="upload-mode" style="display: none;">
                    <form id="upload-form">
                        <div class="form-group">
                            <label for="code-file">é€‰æ‹©ä»£ç æ–‡ä»¶</label>
                            <input type="file" id="code-file" name="file" accept=".py,.js,.jsx,.ts,.tsx,.java,.go,.cpp,.cc,.cxx,.c,.h,.hpp,.txt" required>
                            <small style="color: #666; display: block; margin-top: 5px;">
                                æ”¯æŒ: Python, JavaScript, Java, Go, C/C++ ç­‰ä»£ç æ–‡ä»¶
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="upload-language">ç¼–ç¨‹è¯­è¨€ï¼ˆå¯é€‰ï¼Œå°†è‡ªåŠ¨ä»æ–‡ä»¶åæ¨æ–­ï¼‰</label>
                            <select id="upload-language" name="language">
                                <option value="">è‡ªåŠ¨æ£€æµ‹</option>
                                <option value="python">Python</option>
                                <option value="javascript">JavaScript</option>
                                <option value="java">Java</option>
                                <option value="go">Go</option>
                                <option value="cpp">C++</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary" id="upload-btn">ä¸Šä¼ å¹¶å®¡æŸ¥</button>
                    </form>
                    
                    <div id="upload-preview" style="margin-top: 20px; display: none;">
                        <h4>æ–‡ä»¶é¢„è§ˆ</h4>
                        <pre id="file-preview-content" style="background: #f5f5f5; padding: 15px; border-radius: 6px; max-height: 300px; overflow-y: auto; font-size: 12px;"></pre>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">AIæ­£åœ¨åˆ†æä»£ç ï¼Œè¯·ç¨å€™...</p>
                </div>

                <div class="result" id="result">
                    <h3>å®¡æŸ¥ç»“æœ</h3>
                    <div id="ast-info" style="display: none; margin-bottom: 15px; padding: 12px; background: #e8f4f8; border-radius: 6px; font-size: 14px;">
                        <strong>ğŸ“Š ä»£ç ç»“æ„åˆ†æï¼š</strong>
                        <div id="ast-summary" style="margin-top: 6px;"></div>
                        <div id="ast-structure" class="ast-tree"></div>
                    </div>
                    <div class="stats" id="stats"></div>
                    <div id="issues-container"></div>
                    <div id="saved-comments-info" style="display: none; margin-top: 15px; padding: 10px; background: #d5f4e6; border-radius: 6px; color: #00b894;">
                        <strong>âœ“ ç”¨æˆ·AåŠŸèƒ½ï¼š</strong>å·²è‡ªåŠ¨ä¿å­˜ <span id="saved-count">0</span> æ¡å®¡æŸ¥è¯„è®ºï¼Œä¸‹æ¬¡é‡åˆ°ç±»ä¼¼ä»£ç æ—¶ä¼šè‡ªåŠ¨å…³è”æé†’
                    </div>
                    <div class="related-cases" id="related-cases" style="display: none;">
                        <h4>ç›¸å…³å†å²æ¡ˆä¾‹</h4>
                        <div id="cases-list"></div>
                    </div>
                </div>
            </div>

            <!-- æŸ¥çœ‹å†å²æ ‡ç­¾é¡µï¼ˆç”¨æˆ·BåŠŸèƒ½ï¼‰ -->
            <div id="history-tab" class="tab-content">
                <h3 style="margin-bottom: 20px;">æŸ¥çœ‹ä»£ç å†å²é—®é¢˜å’Œæœ€ä½³å®è·µ</h3>
                <p style="color: #666; margin-bottom: 20px;">è¾“å…¥ä»£ç ç‰‡æ®µï¼ŒæŸ¥çœ‹å›¢é˜Ÿå†å²ä¸Šå¯¹ç±»ä¼¼ä»£ç çš„å®¡æŸ¥æ„è§å’Œæœ€ä½³å®è·µ</p>
                
                <form id="history-form">
                    <div class="form-group">
                        <label for="history-code">ä»£ç å†…å®¹</label>
                        <textarea id="history-code" name="code" placeholder="è¯·ç²˜è´´æˆ–è¾“å…¥è¦æŸ¥è¯¢çš„ä»£ç ..." rows="8" required></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" id="history-btn">æŸ¥çœ‹å†å²</button>
                </form>

                <div class="loading" id="history-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">æ­£åœ¨æŸ¥æ‰¾ç›¸å…³å†å²è®°å½•...</p>
                </div>

                <div id="history-result" style="display: none; margin-top: 30px;">
                    <div class="stats" id="history-stats"></div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: #333; margin-bottom: 15px;">å†å²å®¡æŸ¥é—®é¢˜</h4>
                        <div id="history-issues-list"></div>
                    </div>

                    <div style="margin-top: 30px;">
                        <h4 style="color: #333; margin-bottom: 15px;">å›¢é˜Ÿæœ€ä½³å®è·µ</h4>
                        <div id="best-practices-list"></div>
                    </div>
                </div>
            </div>

            <!-- çŸ¥è¯†åº“æ ‡ç­¾é¡µ -->
            <div id="knowledge-tab" class="tab-content">
                <h3 style="margin-bottom: 20px;">æ·»åŠ çŸ¥è¯†</h3>
                <form id="knowledge-form">
                    <div class="form-group">
                        <label for="knowledge-title">æ ‡é¢˜</label>
                        <input type="text" id="knowledge-title" name="title" required>
                    </div>

                    <div class="form-group">
                        <label for="knowledge-category">åˆ†ç±»</label>
                        <select id="knowledge-category" name="category">
                            <option value="security">å®‰å…¨æ€§</option>
                            <option value="performance">æ€§èƒ½</option>
                            <option value="style">ä»£ç è§„èŒƒ</option>
                            <option value="best_practice">æœ€ä½³å®è·µ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="knowledge-content">å†…å®¹</label>
                        <textarea id="knowledge-content" name="content" rows="6" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="knowledge-code-pattern">ä»£ç æ¨¡å¼ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea id="knowledge-code-pattern" name="code_pattern" rows="3" placeholder="æè¿°æ˜“å‡ºé—®é¢˜çš„ä»£ç ç»“æ„ï¼Œç”¨äºåŒ¹é…æé†’"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="knowledge-best-practice">æœ€ä½³å®è·µå»ºè®®ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea id="knowledge-best-practice" name="best_practice" rows="3" placeholder="è¡¥å……å…·ä½“çš„æ•´æ”¹æ­¥éª¤æˆ–å›¢é˜Ÿè§„èŒƒ"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="knowledge-tags">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼Œå¯é€‰ï¼‰</label>
                        <input type="text" id="knowledge-tags" name="tags" placeholder="ä¾‹å¦‚ï¼šSQL, å®‰å…¨, è§„èŒƒ">
                    </div>

                    <div class="form-group" id="knowledge-status-group" style="display: none;">
                        <label for="knowledge-status">çŠ¶æ€</label>
                        <select id="knowledge-status" name="status">
                            <option value="draft">è‰ç¨¿</option>
                            <option value="pending_review" selected>å¾…å®¡æ ¸</option>
                            <option value="published">å·²å‘å¸ƒ</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">æ·»åŠ çŸ¥è¯†</button>
                </form>

                <div class="knowledge-controls" style="margin-top: 30px;">
                    <input type="text" id="knowledge-search" placeholder="æœç´¢æ ‡é¢˜æˆ–å†…å®¹å…³é”®è¯">
                    <select id="knowledge-status-filter">
                        <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="published">å·²å‘å¸ƒ</option>
                        <option value="pending_review">å¾…å®¡æ ¸</option>
                        <option value="draft">è‰ç¨¿</option>
                    </select>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 40px; margin-bottom: 20px;">
                    <h3 style="margin: 0;">çŸ¥è¯†åˆ—è¡¨</h3>
                    <button class="btn btn-primary" onclick="batchExtractKnowledge()" style="padding: 8px 20px; font-size: 14px;" id="batch-extract-btn">
                        ç”¨æˆ·Cï¼šæ‰¹é‡æå–çŸ¥è¯†
                    </button>
                </div>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    æ‰¹é‡å°†å†å²å®¡æŸ¥è¯„è®ºè‡ªåŠ¨è½¬åŒ–ä¸ºçŸ¥è¯†åº“æ¡ç›®
                </p>
                <div class="knowledge-list" id="knowledge-list">
                    <div class="empty-state">åŠ è½½ä¸­...</div>
                </div>
                
                <!-- åˆ†é¡µæ§ä»¶ -->
                <div id="knowledge-pagination"></div>

                <div style="margin-top: 40px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">çŸ¥è¯†å›¾è°±ï¼ˆCode âœ Review âœ Knowledgeï¼‰</h3>
                        <button class="btn" style="padding: 8px 14px; background: #eef2ff; color: #4c51bf;" onclick="loadKnowledgeGraph(true)">åˆ·æ–°å›¾è°±</button>
                    </div>
                    <div class="graph-container" id="knowledge-graph">
                        <svg id="graph-edges"></svg>
                        <div class="graph-columns">
                            <div class="graph-column">
                                <h4>ä»£ç æ–‡ä»¶</h4>
                                <div class="graph-nodes" id="graph-code-nodes"></div>
                            </div>
                            <div class="graph-column">
                                <h4>å®¡æŸ¥è¯„è®º</h4>
                                <div class="graph-nodes" id="graph-comment-nodes"></div>
                            </div>
                            <div class="graph-column">
                                <h4>çŸ¥è¯†æ¡ç›®</h4>
                                <div class="graph-nodes" id="graph-knowledge-nodes"></div>
                            </div>
                        </div>
                        <div id="graph-empty" class="empty-state" style="position:absolute; left:50%; top:50%; transform:translate(-50%, -50%);">åŠ è½½å›¾è°±ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- çŸ¥è¯†ç¼–è¾‘å¼¹å±‚ -->
            <div id="knowledge-modal" class="modal">
                <div class="modal-content">
                    <h3 style="margin-bottom: 20px;">ç¼–è¾‘çŸ¥è¯†</h3>
                    <form id="knowledge-edit-form">
                        <div class="form-group">
                            <label for="edit-knowledge-title">æ ‡é¢˜</label>
                            <input type="text" id="edit-knowledge-title" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-knowledge-category">åˆ†ç±»</label>
                            <select id="edit-knowledge-category">
                                <option value="security">å®‰å…¨æ€§</option>
                                <option value="performance">æ€§èƒ½</option>
                                <option value="style">ä»£ç è§„èŒƒ</option>
                                <option value="best_practice">æœ€ä½³å®è·µ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-knowledge-content">å†…å®¹</label>
                            <textarea id="edit-knowledge-content" rows="5" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit-knowledge-code-pattern">ä»£ç æ¨¡å¼</label>
                            <textarea id="edit-knowledge-code-pattern" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit-knowledge-best-practice">æœ€ä½³å®è·µå»ºè®®</label>
                            <textarea id="edit-knowledge-best-practice" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit-knowledge-tags">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                            <input type="text" id="edit-knowledge-tags">
                        </div>
                        <div class="form-group">
                            <label for="edit-knowledge-status">çŠ¶æ€</label>
                            <select id="edit-knowledge-status">
                                <option value="draft">è‰ç¨¿</option>
                                <option value="pending_review">å¾…å®¡æ ¸</option>
                                <option value="published">å·²å‘å¸ƒ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-knowledge-notes">å®¡æ ¸å¤‡æ³¨</label>
                            <textarea id="edit-knowledge-notes" rows="2" placeholder="è®°å½•å®¡æ‰¹/é©³å›åŸå› ï¼Œä¾¿äºå›¢é˜Ÿåä½œ"></textarea>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn" onclick="closeKnowledgeModal()">å–æ¶ˆ</button>
                            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- æ•°æ®çœ‹æ¿æ ‡ç­¾é¡µ -->
            <div id="dashboard-tab" class="tab-content">
                <h3 style="margin-bottom: 20px;">æ•°æ®ç»Ÿè®¡ä¸å¯è§†åŒ–çœ‹æ¿</h3>
                
                <div id="dashboard-loading" style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">åŠ è½½æ•°æ®ä¸­...</p>
                </div>
                
                <div id="dashboard-content" style="display: none;">
                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                    <div class="stats-grid" id="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    </div>
                    
                    <!-- é«˜é¢‘é—®é¢˜Top10 -->
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <h4 style="color: #333; margin-bottom: 15px;">é«˜é¢‘é—®é¢˜ Top 10</h4>
                        <div id="top-issues-list"></div>
                    </div>
                    
                    <!-- çŸ¥è¯†æ²‰æ·€è¶‹åŠ¿ -->
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <h4 style="color: #333; margin-bottom: 15px;">çŸ¥è¯†æ²‰æ·€è¶‹åŠ¿ï¼ˆæœ€è¿‘30å¤©ï¼‰</h4>
                        <div id="knowledge-trend-chart" style="height: 300px; position: relative;">
                            <canvas id="trend-canvas"></canvas>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            <p style="margin: 5px 0;"><strong>çŸ¥è¯†æ²‰æ·€ç‡ï¼š</strong><span id="knowledge-rate">0</span>%</p>
                            <div class="progress-bar" style="margin: 6px 0;">
                                <div class="progress" id="knowledge-rate-progress" style="width: 0%; height: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 999px;"></div>
                            </div>
                            <p style="margin: 5px 0;"><strong>æ€»çŸ¥è¯†æ¡ç›®ï¼š</strong><span id="total-knowledge">0</span></p>
                            <p style="margin: 5px 0;"><strong>æ€»å®¡æŸ¥è¯„è®ºï¼š</strong><span id="total-comments">0</span></p>
                            <p style="margin: 5px 0;"><strong>çŸ¥è¯†å¤ç”¨ç‡ï¼š</strong><span id="reuse-rate-chip">0%</span></p>
                        </div>
                    </div>
                    
                    <!-- å®¡æŸ¥ç»Ÿè®¡ -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <h4 style="color: #333; margin-bottom: 15px;">å®¡æŸ¥ç»Ÿè®¡</h4>
                        <div id="review-stats-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8050/api/v1';
        
        // è®¤è¯çŠ¶æ€
        let currentUser = null;
        let authToken = localStorage.getItem('auth_token');
        let knowledgeDataCache = [];
        let editingKnowledgeId = null;
        let knowledgeGraphData = null;
        let graphNodeRefs = {};

        function debounce(func, delay = 300) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.addEventListener('load', async () => {
            if (authToken) {
                try {
                    await checkAuth();
                } catch (e) {
                    showLogin();
                }
            } else {
                showLogin();
            }
        });

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            if (!authToken) {
                showLogin();
                return false;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        currentUser = result.data;
                        showMainApp();
                        return true;
                    }
                }
            } catch (e) {
                console.error('è®¤è¯æ£€æŸ¥å¤±è´¥:', e);
            }

            showLogin();
            return false;
        }

        // æ˜¾ç¤ºç™»å½•ç•Œé¢
        function showLogin() {
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('register-container').style.display = 'none';
            document.getElementById('main-container').style.display = 'none';
        }

        // æ˜¾ç¤ºæ³¨å†Œç•Œé¢
        function showRegister() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('register-container').style.display = 'block';
            document.getElementById('main-container').style.display = 'none';
        }

        // æ˜¾ç¤ºä¸»åº”ç”¨
        function showMainApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('register-container').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            
            initTabs();
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            if (currentUser) {
                document.getElementById('current-username').textContent = currentUser.username;
                const roleBadge = document.getElementById('user-role-badge');
                if (currentUser.role === 'admin') {
                    roleBadge.innerHTML = '<span class="admin-badge">ç®¡ç†å‘˜</span>';
                } else {
                    roleBadge.innerHTML = '';
                }
            }
            
            // åŠ è½½æ•°æ®
            loadKnowledgeList(1);
            loadKnowledgeGraph();
        }

        // ç™»å½•
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                username: formData.get('username'),
                password: formData.get('password')
            };

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    authToken = result.access_token;
                    localStorage.setItem('auth_token', authToken);
                    currentUser = result.user;
                    showMainApp();
                } else {
                    alert('ç™»å½•å¤±è´¥: ' + (result.message || 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'));
                }
            } catch (error) {
                alert('ç™»å½•å¤±è´¥: ' + error.message);
            }
        });

        // æ³¨å†Œ
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                username: formData.get('username'),
                password: formData.get('password'),
                email: formData.get('email') || ''
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
                    showLogin();
                } else {
                    alert('æ³¨å†Œå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ³¨å†Œå¤±è´¥: ' + error.message);
            }
        });

        // é€€å‡ºç™»å½•
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('auth_token');
            showLogin();
        }

        // æ·»åŠ è®¤è¯å¤´åˆ°æ‰€æœ‰APIè¯·æ±‚
        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            return headers;
        }

        // åˆ‡æ¢ä¸Šä¼ æ¨¡å¼
        function switchUploadMode(mode) {
            if (mode === 'paste') {
                document.getElementById('paste-mode').style.display = 'block';
                document.getElementById('upload-mode').style.display = 'none';
                document.getElementById('mode-paste-btn').classList.add('btn-primary');
                document.getElementById('mode-paste-btn').classList.remove('btn');
                document.getElementById('mode-upload-btn').classList.remove('btn-primary');
                document.getElementById('mode-upload-btn').classList.add('btn');
                document.getElementById('mode-upload-btn').style.background = '#f8f9fa';
                document.getElementById('mode-upload-btn').style.border = '1px solid #dee2e6';
            } else {
                document.getElementById('paste-mode').style.display = 'none';
                document.getElementById('upload-mode').style.display = 'block';
                document.getElementById('mode-upload-btn').classList.add('btn-primary');
                document.getElementById('mode-upload-btn').classList.remove('btn');
                document.getElementById('mode-paste-btn').classList.remove('btn-primary');
                document.getElementById('mode-paste-btn').classList.add('btn');
                document.getElementById('mode-paste-btn').style.background = '#f8f9fa';
                document.getElementById('mode-paste-btn').style.border = '1px solid #dee2e6';
            }
        }

        let tabsInitialized = false;
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName, clickedButton) {
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeçŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // æ·»åŠ å½“å‰æ ‡ç­¾çš„activeçŠ¶æ€
            if (clickedButton) {
                clickedButton.classList.add('active');
            } else {
                // å¦‚æœæŒ‰é’®ä¸å¯ç”¨ï¼Œé€šè¿‡data-tabå±æ€§æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®
                const targetTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
            }
            
            // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹åŒºåŸŸ
            const contentTab = document.getElementById(tabName + '-tab');
            if (contentTab) {
                contentTab.classList.add('active');
            }
            
            // åŠ è½½å¯¹åº”æ ‡ç­¾é¡µçš„æ•°æ®
            if (tabName === 'knowledge') {
                loadKnowledgeList(1);
                loadKnowledgeGraph();
            } else if (tabName === 'dashboard') {
                loadDashboard();
            }
        }
        
        // åˆå§‹åŒ–æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab');
            if (!tabButtons || tabButtons.length === 0) {
                return;
            }
            
            if (!tabsInitialized) {
                tabButtons.forEach(tab => {
                    tab.addEventListener('click', (event) => {
                        event.preventDefault();
                        const tabName = tab.dataset.tab;
                        switchTab(tabName, tab);
                    });
                });
                tabsInitialized = true;
            }
            
            const defaultTab = document.querySelector('.tab[data-tab="review"]');
            if (defaultTab) {
                switchTab('review', defaultTab);
            }
        }
        
        document.addEventListener('DOMContentLoaded', initTabs);
        window.addEventListener('resize', debounce(drawGraphEdges, 200));

        // ä»£ç å®¡æŸ¥è¡¨å•æäº¤
        document.getElementById('review-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                code: formData.get('code'),
                language: formData.get('language'),
                file_name: formData.get('file_name')
            };

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').classList.add('active');
            document.getElementById('result').classList.remove('active');
            document.getElementById('review-btn').disabled = true;

            try {
                const response = await fetch(`${API_BASE}/code/review`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(data)
                });
                
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }

                const result = await response.json();
                
                if (result.success) {
                    displayReviewResult(result.data);
                } else {
                    alert('å®¡æŸ¥å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('review-btn').disabled = false;
            }
        });

        // æ–‡ä»¶ä¸Šä¼ é¢„è§ˆ
        document.getElementById('code-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                document.getElementById('file-preview-content').textContent = text.substring(0, 1000) + (text.length > 1000 ? '\n\n... (æ–‡ä»¶è¿‡é•¿ï¼Œä»…æ˜¾ç¤ºå‰1000å­—ç¬¦)' : '');
                document.getElementById('upload-preview').style.display = 'block';
            } catch (error) {
                alert('è¯»å–æ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        });

        // æ–‡ä»¶ä¸Šä¼ è¡¨å•æäº¤
        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('code-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const language = document.getElementById('upload-language').value;
            if (language) {
                formData.append('language', language);
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').classList.add('active');
            document.getElementById('result').classList.remove('active');
            document.getElementById('upload-btn').disabled = true;

            try {
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`${API_BASE}/code/upload`, {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });
                
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }

                const result = await response.json();
                
                if (result.success) {
                    displayReviewResult(result.data);
                    // åˆ‡æ¢åˆ°ç²˜è´´æ¨¡å¼æ˜¾ç¤ºç»“æœ
                    switchUploadMode('paste');
                } else {
                    alert('ä¸Šä¼ å®¡æŸ¥å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('upload-btn').disabled = false;
            }
        });

        // æ˜¾ç¤ºå®¡æŸ¥ç»“æœ
        function displayReviewResult(data) {
            const issues = data.issues || [];
            const relatedCases = data.related_cases || [];
            const savedComments = data.saved_comments || [];
            
            // æ˜¾ç¤ºASTä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            const astSummaryEl = document.getElementById('ast-summary');
            const astStructureEl = document.getElementById('ast-structure');
            if (data.ast_info || data.file_name) {
                const astInfo = data.ast_info || {};
                const astDetails = [];
                
                if (astInfo.function_count > 0) {
                    astDetails.push(`${astInfo.function_count} ä¸ªå‡½æ•°`);
                }
                if (astInfo.class_count > 0) {
                    astDetails.push(`${astInfo.class_count} ä¸ªç±»`);
                }
                if (astInfo.import_count > 0) {
                    astDetails.push(`${astInfo.import_count} ä¸ªå¯¼å…¥`);
                }
                
                if (astDetails.length > 0) {
                    document.getElementById('ast-info').style.display = 'block';
                    if (astSummaryEl) {
                        astSummaryEl.textContent = astDetails.join('ï¼Œ');
                    }
                    renderAstStructure(astInfo);
                } else {
                    document.getElementById('ast-info').style.display = 'none';
                    if (astSummaryEl) astSummaryEl.textContent = '';
                    if (astStructureEl) astStructureEl.innerHTML = '';
                }
            } else {
                document.getElementById('ast-info').style.display = 'none';
                if (astSummaryEl) astSummaryEl.textContent = '';
                if (astStructureEl) astStructureEl.innerHTML = '';
            }
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            const statsHtml = `
                <div class="stat-item">
                    <div class="stat-value">${issues.length}</div>
                    <div class="stat-label">å‘ç°é—®é¢˜</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${data.review_time_ms || 0}ms</div>
                    <div class="stat-label">å®¡æŸ¥è€—æ—¶</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${relatedCases.length}</div>
                    <div class="stat-label">ç›¸å…³æ¡ˆä¾‹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${savedComments.length}</div>
                    <div class="stat-label">å·²ä¿å­˜è¯„è®º</div>
                </div>
            `;
            document.getElementById('stats').innerHTML = statsHtml;
            
            // ç”¨æˆ·AåŠŸèƒ½ï¼šæ˜¾ç¤ºå·²ä¿å­˜çš„è¯„è®ºä¿¡æ¯
            if (savedComments.length > 0) {
                document.getElementById('saved-comments-info').style.display = 'block';
                document.getElementById('saved-count').textContent = savedComments.length;
            } else {
                document.getElementById('saved-comments-info').style.display = 'none';
            }

            // æ˜¾ç¤ºé—®é¢˜åˆ—è¡¨
            const issuesContainer = document.getElementById('issues-container');
            if (issues.length === 0) {
                issuesContainer.innerHTML = '<div class="empty-state">âœ… ä»£ç å®¡æŸ¥é€šè¿‡ï¼Œæœªå‘ç°é—®é¢˜ï¼</div>';
            } else {
                issuesContainer.innerHTML = issues.map(issue => `
                    <div class="issue-card ${issue.severity}">
                        <div class="issue-header">
                            <span class="issue-type ${issue.type}">${getTypeName(issue.type)}</span>
                            <span class="severity-badge ${issue.severity}">${getSeverityName(issue.severity)}</span>
                        </div>
                        <p style="margin: 10px 0; color: #333;"><strong>é—®é¢˜:</strong> ${issue.description}</p>
                        <p style="margin: 10px 0; color: #555;"><strong>å»ºè®®:</strong> ${issue.suggestion}</p>
                        ${issue.code_snippet ? `<pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 12px;">${escapeHtml(issue.code_snippet)}</pre>` : ''}
                        <button onclick="showChatDialog(${data.review_id || 'null'}, '${escapeHtml(issue.description + ' ' + issue.suggestion)}')" style="margin-top: 10px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            ğŸ’¬ æ™ºèƒ½è¿½é—®
                        </button>
                    </div>
                `).join('');
            }

            // æ˜¾ç¤ºç›¸å…³æ¡ˆä¾‹
            if (relatedCases.length > 0) {
                document.getElementById('related-cases').style.display = 'block';
                document.getElementById('cases-list').innerHTML = relatedCases.map(case_ => `
                    <div class="case-item">
                        <strong>${case_.type === 'review_comment' ? 'å®¡æŸ¥è¯„è®º' : 'çŸ¥è¯†åº“'}:</strong> 
                        ${case_.comment_text || case_.content || case_.title}
                        ${case_.similarity ? `<span style="float: right; color: #667eea;">ç›¸ä¼¼åº¦: ${(case_.similarity * 100).toFixed(1)}%</span>` : ''}
                    </div>
                `).join('');
            } else {
                document.getElementById('related-cases').style.display = 'none';
            }

            document.getElementById('result').classList.add('active');
        }

        function renderAstStructure(astInfo) {
            const container = document.getElementById('ast-structure');
            if (!container) return;
            if (!astInfo) {
                container.innerHTML = '';
                return;
            }
            let html = '';
            if (Array.isArray(astInfo.functions) && astInfo.functions.length) {
                const items = astInfo.functions.slice(0, 15).map(fn => {
                    const args = (fn.args || []).join(', ');
                    return `<li><strong>${escapeHtml(fn.name || 'åŒ¿åå‡½æ•°')}</strong>${args ? `(${escapeHtml(args)})` : ''}</li>`;
                }).join('');
                html += `<details open><summary>å‡½æ•° (${astInfo.functions.length})</summary><ul>${items}</ul></details>`;
            }
            if (Array.isArray(astInfo.classes) && astInfo.classes.length) {
                const items = astInfo.classes.slice(0, 10).map(cls => {
                    const methods = (cls.methods || []).slice(0, 5).join(', ');
                    return `<li><strong>${escapeHtml(cls.name || 'åŒ¿åç±»')}</strong>${methods ? ` Â· æ–¹æ³•: ${escapeHtml(methods)}` : ''}</li>`;
                }).join('');
                html += `<details><summary>ç±» (${astInfo.classes.length})</summary><ul>${items}</ul></details>`;
            }
            if (Array.isArray(astInfo.imports) && astInfo.imports.length) {
                const items = astInfo.imports.slice(0, 10).map(imp => `<li>${escapeHtml(imp.module || imp)}</li>`).join('');
                html += `<details><summary>ä¾èµ–/å¯¼å…¥ (${astInfo.import_count || astInfo.imports.length})</summary><ul>${items}</ul></details>`;
            }
            if (Array.isArray(astInfo.variables) && astInfo.variables.length) {
                const items = astInfo.variables.slice(0, 10).map(v => `<li>${escapeHtml(v.name || '')}</li>`).join('');
                html += `<details><summary>å˜é‡ (${astInfo.variables.length})</summary><ul>${items}</ul></details>`;
            }
            container.innerHTML = html || '<div style="color:#64748b;">æœªè§£æåˆ°è¯¦ç»†ç»“æ„ã€‚</div>';
        }

        // çŸ¥è¯†åº“è¡¨å•æäº¤
        document.getElementById('knowledge-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const tagsInput = formData.get('tags') || '';
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            const data = {
                title: formData.get('title'),
                content: formData.get('content'),
                category: formData.get('category'),
                code_pattern: formData.get('code_pattern') || '',
                best_practice: formData.get('best_practice') || '',
                tags
            };
            if (currentUser && currentUser.role === 'admin') {
                data.status = document.getElementById('knowledge-status').value;
            }

            try {
                const response = await fetch(`${API_BASE}/knowledge`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(data)
                });
                
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }

                const result = await response.json();
                
                if (result.success) {
                    alert('çŸ¥è¯†æ·»åŠ æˆåŠŸï¼');
                    e.target.reset();
                    loadKnowledgeList(1);
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        });

        // åˆ†é¡µçŠ¶æ€
        let currentPage = 1;
        const pageSize = 10;
        let totalPages = 1;
        let totalItems = 0;

        // åŠ è½½çŸ¥è¯†åˆ—è¡¨
        async function loadKnowledgeList(page = 1) {
            const listEl = document.getElementById('knowledge-list');
            if (!listEl) return;
            
            currentPage = page;
            listEl.innerHTML = '<div class="empty-state">åŠ è½½ä¸­...</div>';
            
            try {
                const statusFilter = document.getElementById('knowledge-status-filter')?.value || 'all';
                const keyword = document.getElementById('knowledge-search')?.value.trim() || '';
                const params = new URLSearchParams();
                if (statusFilter && statusFilter !== 'all') {
                    params.append('status', statusFilter);
                }
                if (keyword) {
                    params.append('keyword', keyword);
                }
                params.append('page', page.toString());
                params.append('page_size', pageSize.toString());
                
                let url = `${API_BASE}/knowledge?${params.toString()}`;
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }
                
                // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage += ': ' + (errorData.detail || errorData.message || 'æœåŠ¡å™¨é”™è¯¯');
                    } catch (e) {
                        errorMessage += ': æ— æ³•è§£æé”™è¯¯ä¿¡æ¯';
                    }
                    listEl.innerHTML = `<div class="empty-state">åŠ è½½å¤±è´¥: ${errorMessage}</div>`;
                    console.error('åŠ è½½çŸ¥è¯†åˆ—è¡¨å¤±è´¥:', errorMessage);
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data || {};
                    knowledgeDataCache = data.items || [];
                    totalPages = data.total_pages || 1;
                    totalItems = data.total || 0;
                    renderKnowledgeList();
                    renderPagination();
                } else {
                    const errorMsg = result.message || result.detail || 'æœªçŸ¥é”™è¯¯';
                    listEl.innerHTML = `<div class="empty-state">åŠ è½½å¤±è´¥: ${errorMsg}</div>`;
                    console.error('çŸ¥è¯†åˆ—è¡¨APIè¿”å›å¤±è´¥:', result);
                }
            } catch (error) {
                console.error('åŠ è½½çŸ¥è¯†åˆ—è¡¨å¼‚å¸¸:', error);
                listEl.innerHTML = `<div class="empty-state">åŠ è½½å¤±è´¥: ${error.message || 'ç½‘ç»œé”™è¯¯'}</div>`;
            }
        }
        
        // æ¸²æŸ“åˆ†é¡µæ§ä»¶
        function renderPagination() {
            const paginationEl = document.getElementById('knowledge-pagination');
            if (!paginationEl) return;
            
            if (totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }
            
            let paginationHtml = '<div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            if (currentPage > 1) {
                paginationHtml += `<button onclick="loadKnowledgeList(${currentPage - 1})" style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">ä¸Šä¸€é¡µ</button>`;
            } else {
                paginationHtml += `<button disabled style="padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; border-radius: 6px; color: #999; cursor: not-allowed;">ä¸Šä¸€é¡µ</button>`;
            }
            
            // é¡µç æŒ‰é’®
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            if (startPage > 1) {
                paginationHtml += `<button onclick="loadKnowledgeList(1)" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">1</button>`;
                if (startPage > 2) {
                    paginationHtml += `<span style="padding: 8px;">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    paginationHtml += `<button style="padding: 8px 12px; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: bold;">${i}</button>`;
                } else {
                    paginationHtml += `<button onclick="loadKnowledgeList(${i})" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">${i}</button>`;
                }
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHtml += `<span style="padding: 8px;">...</span>`;
                }
                paginationHtml += `<button onclick="loadKnowledgeList(${totalPages})" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">${totalPages}</button>`;
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            if (currentPage < totalPages) {
                paginationHtml += `<button onclick="loadKnowledgeList(${currentPage + 1})" style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">ä¸‹ä¸€é¡µ</button>`;
            } else {
                paginationHtml += `<button disabled style="padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; border-radius: 6px; color: #999; cursor: not-allowed;">ä¸‹ä¸€é¡µ</button>`;
            }
            
            paginationHtml += `<span style="margin-left: 20px; color: #666;">å…± ${totalItems} æ¡ï¼Œç¬¬ ${currentPage}/${totalPages} é¡µ</span>`;
            paginationHtml += '</div>';
            
            paginationEl.innerHTML = paginationHtml;
        }

        async function loadKnowledgeGraph(forceRefresh = false) {
            const container = document.getElementById('knowledge-graph');
            if (!container || !authToken) return;
            const emptyState = document.getElementById('graph-empty');
            if (emptyState) {
                emptyState.style.display = 'block';
                emptyState.textContent = 'åŠ è½½å›¾è°±ä¸­...';
            }
            try {
                const response = await fetch(`${API_BASE}/knowledge/graph`, {
                    headers: getAuthHeaders()
                });
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }
                const result = await response.json();
                if (result.success) {
                    knowledgeGraphData = result.data || { nodes: [], edges: [] };
                    renderKnowledgeGraph(knowledgeGraphData);
                } else {
                    if (emptyState) {
                        emptyState.style.display = 'block';
                        emptyState.textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                    }
                }
            } catch (error) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                    emptyState.textContent = 'åŠ è½½å¤±è´¥: ' + error.message;
                }
            }
        }

        function renderKnowledgeGraph(data) {
            const codeColumn = document.getElementById('graph-code-nodes');
            const commentColumn = document.getElementById('graph-comment-nodes');
            const knowledgeColumn = document.getElementById('graph-knowledge-nodes');
            const emptyState = document.getElementById('graph-empty');
            if (!codeColumn || !commentColumn || !knowledgeColumn) return;
            
            codeColumn.innerHTML = '';
            commentColumn.innerHTML = '';
            knowledgeColumn.innerHTML = '';
            graphNodeRefs = {};
            
            if (!data || !data.nodes || data.nodes.length === 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                    emptyState.textContent = 'æš‚æ— å›¾è°±æ•°æ®';
                }
                const svg = document.getElementById('graph-edges');
                if (svg) svg.innerHTML = '';
                return;
            }
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            const columnMap = {
                'code_file': codeColumn,
                'review_comment': commentColumn,
                'knowledge': knowledgeColumn
            };
            
            data.nodes.forEach(node => {
                const column = columnMap[node.type];
                if (!column) {
                    return;
                }
                const nodeEl = document.createElement('div');
                nodeEl.className = `graph-node graph-node-${node.type}`;
                const label = escapeHtml(node.label || node.type);
                const subLabel = escapeHtml(node.sub_label || '');
                nodeEl.innerHTML = `
                    <div class="title">${label}</div>
                    <div class="meta">${subLabel}</div>
                `;
                column.appendChild(nodeEl);
                graphNodeRefs[node.id] = nodeEl;
            });
            
            setTimeout(drawGraphEdges, 60);
        }

        function drawGraphEdges() {
            if (!knowledgeGraphData) return;
            const container = document.getElementById('knowledge-graph');
            const svg = document.getElementById('graph-edges');
            if (!container || !svg) return;
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.innerHTML = '';
            
            const containerRect = container.getBoundingClientRect();
            knowledgeGraphData.edges.forEach(edge => {
                const sourceEl = graphNodeRefs[edge.source];
                const targetEl = graphNodeRefs[edge.target];
                if (!sourceEl || !targetEl) return;
                const sourceRect = sourceEl.getBoundingClientRect();
                const targetRect = targetEl.getBoundingClientRect();
                const startX = sourceRect.right - containerRect.left;
                const startY = sourceRect.top - containerRect.top + sourceRect.height / 2;
                const endX = targetRect.left - containerRect.left;
                const endY = targetRect.top - containerRect.top + targetRect.height / 2;
                const midX = (startX + endX) / 2;
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M${startX},${startY} C ${midX},${startY} ${midX},${endY} ${endX},${endY}`);
                path.setAttribute('fill', 'none');
                path.setAttribute('stroke', getEdgeColor(edge.type));
                path.setAttribute('stroke-width', '1.5');
                path.setAttribute('opacity', '0.7');
                svg.appendChild(path);
            });
        }

        function renderKnowledgeList() {
            const listContainer = document.getElementById('knowledge-list');
            if (!listContainer) return;
            
            if (!knowledgeDataCache || knowledgeDataCache.length === 0) {
                listContainer.innerHTML = '<div class="empty-state">æš‚æ— çŸ¥è¯†ï¼Œè¯·æ·»åŠ ç¬¬ä¸€æ¡çŸ¥è¯†</div>';
                return;
            }
            
            listContainer.innerHTML = knowledgeDataCache.map(knowledge => {
                const tagsHtml = (knowledge.tags && knowledge.tags.length)
                    ? knowledge.tags.map(tag => `<span class="tag-chip">${escapeHtml(tag)}</span>`).join('')
                    : '<span class="tag-chip" style="background:#ede9fe;color:#5b21b6;">æœªè®¾ç½®æ ‡ç­¾</span>';
                const statusClass = `status-badge status-${knowledge.status || 'draft'}`;
                const canManage = canManageKnowledge(knowledge);
                const codePatternHtml = knowledge.code_pattern
                    ? `<div style="margin-top: 10px;"><strong>ä»£ç æ¨¡å¼ï¼š</strong><pre style="white-space: pre-wrap; background: #fff; border-radius: 6px; padding: 10px; margin-top: 6px;">${escapeHtml(knowledge.code_pattern)}</pre></div>`
                    : '';
                const bestPracticeHtml = knowledge.best_practice
                    ? `<div style="margin-top: 10px;"><strong>æœ€ä½³å®è·µï¼š</strong><div style="margin-top: 6px; color:#425466;">${escapeHtml(knowledge.best_practice)}</div></div>`
                    : '';
                const notesHtml = knowledge.review_notes
                    ? `<p style="margin-top: 10px; font-size: 12px; color: #a16207;">å¤‡æ³¨ï¼š${escapeHtml(knowledge.review_notes)}</p>`
                    : '';
                // å®¡æ ¸æŒ‰é’®ï¼ˆä»…å®¡æ ¸å‘˜å¯è§ï¼‰
                const canApprove = currentUser && (currentUser.role === 'admin' || currentUser.role === 'reviewer' || currentUser.role === 'curator');
                const isPendingReview = knowledge.status === 'pending_review';
                const approveButtonsHtml = (canApprove && isPendingReview) ? `
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button type="button" onclick="quickApprove(${knowledge.id})" style="padding: 6px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">âœ“ æ‰¹å‡†</button>
                        <button type="button" onclick="quickReject(${knowledge.id})" style="padding: 6px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">âœ— é©³å›</button>
                    </div>
                ` : '';
                
                const actionsHtml = canManage ? `
                    <div class="knowledge-actions">
                        <button type="button" onclick="openKnowledgeModal(${knowledge.id})">ç¼–è¾‘</button>
                        <button type="button" class="danger" onclick="deleteKnowledge(${knowledge.id})">åˆ é™¤</button>
                    </div>
                ` : '';
                
                return `
                    <div class="knowledge-item">
                        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span class="category">${getCategoryName(knowledge.category)}</span>
                            <span class="${statusClass}">${getStatusName(knowledge.status)}</span>
                        </div>
                        <h4>${escapeHtml(knowledge.title)}</h4>
                        <p style="color: #666; line-height: 1.6; white-space: pre-wrap;">${escapeHtml(knowledge.content)}</p>
                        ${bestPracticeHtml}
                        ${codePatternHtml}
                        <div style="margin-top: 12px;">${tagsHtml}</div>
                        <p style="margin-top: 10px; font-size: 12px; color: #999;">
                            æ›´æ–°æ—¶é—´: ${formatDateTime(knowledge.updated_at || knowledge.created_at)}
                        </p>
                        ${notesHtml}
                        ${approveButtonsHtml}
                        ${actionsHtml}
                    </div>
                `;
            }).join('');
        }
        
        // å¿«é€Ÿæ‰¹å‡†
        async function quickApprove(knowledgeId) {
            if (!confirm('ç¡®å®šè¦æ‰¹å‡†å¹¶å‘å¸ƒè¿™æ¡çŸ¥è¯†å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/knowledge/${knowledgeId}/approve`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }
                
                if (response.status === 403) {
                    alert('éœ€è¦å®¡æ ¸å‘˜æƒé™æ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œ');
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert('çŸ¥è¯†å·²æ‰¹å‡†å¹¶å‘å¸ƒ');
                    loadKnowledgeList(currentPage);
                } else {
                    alert('æ‰¹å‡†å¤±è´¥: ' + (result.message || result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ‰¹å‡†çŸ¥è¯†å¤±è´¥:', error);
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // å¿«é€Ÿé©³å›
        async function quickReject(knowledgeId) {
            const notes = prompt('è¯·è¾“å…¥é©³å›åŸå› ï¼ˆå¿…å¡«ï¼‰ï¼š');
            if (!notes || !notes.trim()) {
                alert('é©³å›åŸå› ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦é©³å›è¿™æ¡çŸ¥è¯†å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/knowledge/${knowledgeId}/reject`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        review_notes: notes.trim()
                    })
                });
                
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }
                
                if (response.status === 403) {
                    alert('éœ€è¦å®¡æ ¸å‘˜æƒé™æ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œ');
                    return;
                }
                
                if (response.status === 400) {
                    const errorData = await response.json();
                    alert('é©³å›å¤±è´¥: ' + (errorData.detail || 'è¯·å¡«å†™é©³å›åŸå› '));
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert('çŸ¥è¯†å·²é©³å›');
                    loadKnowledgeList(currentPage);
                } else {
                    alert('é©³å›å¤±è´¥: ' + (result.message || result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('é©³å›çŸ¥è¯†å¤±è´¥:', error);
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        const knowledgeStatusFilterEl = document.getElementById('knowledge-status-filter');
        if (knowledgeStatusFilterEl) {
            knowledgeStatusFilterEl.addEventListener('change', () => loadKnowledgeList(1));
        }
        const knowledgeSearchInputEl = document.getElementById('knowledge-search');
        const debouncedKnowledgeSearch = debounce(() => loadKnowledgeList(1), 400);
        if (knowledgeSearchInputEl) {
            knowledgeSearchInputEl.addEventListener('input', () => debouncedKnowledgeSearch());
        }

        // å·¥å…·å‡½æ•°
        function getTypeName(type) {
            const names = {
                'security': 'å®‰å…¨æ€§',
                'performance': 'æ€§èƒ½',
                'style': 'ä»£ç è§„èŒƒ',
                'best_practice': 'æœ€ä½³å®è·µ',
                'general': 'ä¸€èˆ¬é—®é¢˜'
            };
            return names[type] || type;
        }

        function getSeverityName(severity) {
            const names = {
                'high': 'é«˜',
                'medium': 'ä¸­',
                'low': 'ä½'
            };
            return names[severity] || severity;
        }

        function getCategoryName(category) {
            const names = {
                'security': 'å®‰å…¨æ€§',
                'performance': 'æ€§èƒ½',
                'style': 'ä»£ç è§„èŒƒ',
                'best_practice': 'æœ€ä½³å®è·µ'
            };
            return names[category] || category || 'æœªåˆ†ç±»';
        }

        function getStatusName(status) {
            const names = {
                'draft': 'è‰ç¨¿',
                'pending_review': 'å¾…å®¡æ ¸',
                'published': 'å·²å‘å¸ƒ'
            };
            return names[status] || 'æœªçŸ¥çŠ¶æ€';
        }

        function formatDateTime(value) {
            if (!value) return 'æœªçŸ¥';
            return new Date(value).toLocaleString('zh-CN');
        }

        function canManageKnowledge(knowledge) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin' || currentUser.role === 'curator') return true;
            return knowledge.created_by === currentUser.id;
        }

        function getEdgeColor(type) {
            const colors = {
                'review': '#94a3b8',
                'derived': '#ec4899',
                'reference': '#14b8a6'
            };
            return colors[type] || '#cbd5f5';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openKnowledgeModal(id) {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            const record = knowledgeDataCache.find(item => item.id === id);
            if (!record) return;
            if (!canManageKnowledge(record)) {
                alert('æ— æƒé™ç¼–è¾‘è¯¥çŸ¥è¯†');
                return;
            }
            editingKnowledgeId = id;
            document.getElementById('edit-knowledge-title').value = record.title || '';
            document.getElementById('edit-knowledge-category').value = record.category || 'general';
            document.getElementById('edit-knowledge-content').value = record.content || '';
            document.getElementById('edit-knowledge-code-pattern').value = record.code_pattern || '';
            document.getElementById('edit-knowledge-best-practice').value = record.best_practice || '';
            document.getElementById('edit-knowledge-tags').value = (record.tags || []).join(', ');
            document.getElementById('edit-knowledge-status').value = record.status || 'draft';
            document.getElementById('edit-knowledge-notes').value = record.review_notes || '';
            
            const statusField = document.getElementById('edit-knowledge-status');
            if (currentUser.role === 'admin') {
                statusField.removeAttribute('disabled');
            } else {
                statusField.setAttribute('disabled', 'disabled');
            }
            
            document.getElementById('knowledge-modal').classList.add('show');
        }

        function closeKnowledgeModal() {
            editingKnowledgeId = null;
            document.getElementById('knowledge-edit-form').reset();
            document.getElementById('knowledge-modal').classList.remove('show');
        }

        const knowledgeModalEl = document.getElementById('knowledge-modal');
        if (knowledgeModalEl) {
            knowledgeModalEl.addEventListener('click', (event) => {
                if (event.target.id === 'knowledge-modal') {
                    closeKnowledgeModal();
                }
            });
        }

        document.getElementById('knowledge-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!editingKnowledgeId) return;
            
            const payload = {
                title: document.getElementById('edit-knowledge-title').value,
                content: document.getElementById('edit-knowledge-content').value,
                category: document.getElementById('edit-knowledge-category').value,
                code_pattern: document.getElementById('edit-knowledge-code-pattern').value,
                best_practice: document.getElementById('edit-knowledge-best-practice').value,
                tags: document.getElementById('edit-knowledge-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                review_notes: document.getElementById('edit-knowledge-notes').value
            };
            if (currentUser.role === 'admin') {
                payload.status = document.getElementById('edit-knowledge-status').value;
            }
            
            try {
                const response = await fetch(`${API_BASE}/knowledge/${editingKnowledgeId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(payload)
                });
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }
                const result = await response.json();
                if (result.success) {
                    alert('çŸ¥è¯†å·²æ›´æ–°');
                    closeKnowledgeModal();
                    loadKnowledgeList(currentPage);
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        });

        async function deleteKnowledge(id) {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            const record = knowledgeDataCache.find(item => item.id === id);
            if (!record) return;
            if (!canManageKnowledge(record)) {
                alert('æ— æƒé™åˆ é™¤è¯¥çŸ¥è¯†');
                return;
            }
            if (!confirm(`ç¡®å®šåˆ é™¤â€œ${record.title}â€å—ï¼Ÿ`)) {
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/knowledge/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }
                const result = await response.json();
                if (result.success) {
                    alert('çŸ¥è¯†å·²åˆ é™¤');
                    // å¦‚æœå½“å‰é¡µæ²¡æœ‰æ•°æ®äº†ï¼Œå›åˆ°ä¸Šä¸€é¡µæˆ–ç¬¬ä¸€é¡µ
                    if (knowledgeDataCache.length === 1 && currentPage > 1) {
                        loadKnowledgeList(currentPage - 1);
                    } else {
                        loadKnowledgeList(currentPage);
                    }
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // ç”¨æˆ·BåŠŸèƒ½ï¼šæŸ¥çœ‹ä»£ç å†å²
        document.getElementById('history-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const code = formData.get('code');
            
            if (!code || code.trim() === '') {
                alert('è¯·è¾“å…¥ä»£ç å†…å®¹');
                return;
            }
            
            document.getElementById('history-loading').style.display = 'block';
            document.getElementById('history-result').style.display = 'none';
            document.getElementById('history-btn').disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/code/history`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ code: code, top_k: 10 })
                });
                
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayHistoryResult(result.data);
                } else {
                    alert('æŸ¥è¯¢å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('history-loading').style.display = 'none';
                document.getElementById('history-btn').disabled = false;
            }
        });
        
        // æ˜¾ç¤ºå†å²æŸ¥è¯¢ç»“æœ
        function displayHistoryResult(data) {
            const historyIssues = data.history_issues || [];
            const bestPractices = data.best_practices || [];
            
            // æ˜¾ç¤ºç»Ÿè®¡
            const statsHtml = `
                <div class="stat-item">
                    <div class="stat-value">${historyIssues.length}</div>
                    <div class="stat-label">å†å²é—®é¢˜</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${bestPractices.length}</div>
                    <div class="stat-label">æœ€ä½³å®è·µ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${data.total_found || 0}</div>
                    <div class="stat-label">æ€»è®¡</div>
                </div>
            `;
            document.getElementById('history-stats').innerHTML = statsHtml;
            
            // æ˜¾ç¤ºå†å²é—®é¢˜
            const issuesContainer = document.getElementById('history-issues-list');
            if (historyIssues.length === 0) {
                issuesContainer.innerHTML = '<div class="empty-state">æœªæ‰¾åˆ°ç›¸å…³å†å²é—®é¢˜</div>';
            } else {
                issuesContainer.innerHTML = historyIssues.map(issue => `
                    <div class="case-item">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span class="issue-type ${issue.type}">${getTypeName(issue.type)}</span>
                            <span class="severity-badge ${issue.severity}">${getSeverityName(issue.severity)}</span>
                        </div>
                        <p style="color: #333; line-height: 1.6;">${escapeHtml(issue.comment)}</p>
                        ${issue.similarity ? `<p style="margin-top: 5px; font-size: 12px; color: #667eea;">ç›¸ä¼¼åº¦: ${(issue.similarity * 100).toFixed(1)}%</p>` : ''}
                    </div>
                `).join('');
            }
            
            // æ˜¾ç¤ºæœ€ä½³å®è·µ
            const practicesContainer = document.getElementById('best-practices-list');
            if (bestPractices.length === 0) {
                practicesContainer.innerHTML = '<div class="empty-state">æœªæ‰¾åˆ°ç›¸å…³æœ€ä½³å®è·µ</div>';
            } else {
                practicesContainer.innerHTML = bestPractices.map(practice => `
                    <div class="knowledge-item">
                        <span class="category">${getCategoryName(practice.category)}</span>
                        <h4>${escapeHtml(practice.title)}</h4>
                        <p style="color: #666; line-height: 1.6;">${escapeHtml(practice.content)}</p>
                        ${practice.similarity ? `<p style="margin-top: 10px; font-size: 12px; color: #667eea;">ç›¸ä¼¼åº¦: ${(practice.similarity * 100).toFixed(1)}%</p>` : ''}
                    </div>
                `).join('');
            }
            
            document.getElementById('history-result').style.display = 'block';
        }
        
        // ç”¨æˆ·CåŠŸèƒ½ï¼šæ‰¹é‡æå–çŸ¥è¯†
        async function batchExtractKnowledge() {
            if (!confirm('ç¡®å®šè¦æ‰¹é‡å°†å®¡æŸ¥è¯„è®ºè½¬åŒ–ä¸ºçŸ¥è¯†åº“å—ï¼Ÿ\nè¿™å°†å¤„ç†æ‰€æœ‰ä¸­é«˜ä¸¥é‡ç¨‹åº¦çš„å®¡æŸ¥è¯„è®ºã€‚')) {
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const batchBtn = document.getElementById('batch-extract-btn');
            const originalText = batchBtn ? batchBtn.textContent : '';
            if (batchBtn) {
                batchBtn.disabled = true;
                batchBtn.textContent = 'æå–ä¸­...';
            }
            
            try {
                const response = await fetch(`${API_BASE}/knowledge/batch-extract?min_severity=medium`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }
                
                if (response.status === 403) {
                    alert('éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œ');
                    return;
                }
                
                // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}: `;
                    try {
                        const errorData = await response.json();
                        errorMessage += errorData.detail || errorData.message || 'æœåŠ¡å™¨é”™è¯¯';
                    } catch (e) {
                        errorMessage += await response.text() || 'æœªçŸ¥é”™è¯¯';
                    }
                    alert('æ‰¹é‡æå–å¤±è´¥: ' + errorMessage);
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    let message = `æ‰¹é‡æå–å®Œæˆï¼\n\n`;
                    message += `æ€»è®¡: ${data.total_comments || 0} æ¡è¯„è®º\n`;
                    message += `æˆåŠŸæå–: ${data.extracted || 0} æ¡çŸ¥è¯†\n`;
                    message += `å¤±è´¥: ${data.failed || 0} æ¡\n`;
                    if (data.skipped !== undefined) {
                        message += `è·³è¿‡: ${data.skipped || 0} æ¡`;
                    }
                    
                    if (data.error_samples && data.error_samples.length > 0) {
                        message += `\n\né”™è¯¯ç¤ºä¾‹ï¼ˆå‰5ä¸ªï¼‰:\n`;
                        data.error_samples.slice(0, 3).forEach((err, idx) => {
                            message += `${idx + 1}. ${err.substring(0, 50)}...\n`;
                        });
                    }
                    
                    alert(message);
                    loadKnowledgeList(1);
                } else {
                    alert('æ‰¹é‡æå–å¤±è´¥: ' + (result.message || result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ‰¹é‡æå–é”™è¯¯:', error);
                alert('è¯·æ±‚å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥'));
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (batchBtn) {
                    batchBtn.disabled = false;
                    batchBtn.textContent = originalText;
                }
            }
        }
        
        // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤º/éšè—åŠŸèƒ½
        function updateUIForUserRole() {
            const batchBtn = document.getElementById('batch-extract-btn');
            if (batchBtn) {
                batchBtn.style.display = (currentUser && currentUser.role === 'admin') ? 'inline-block' : 'none';
            }
            const statusGroup = document.getElementById('knowledge-status-group');
            if (statusGroup) {
                if (currentUser && currentUser.role === 'admin') {
                    statusGroup.style.display = 'block';
                } else {
                    statusGroup.style.display = 'none';
                    const statusSelect = document.getElementById('knowledge-status');
                    if (statusSelect) {
                        statusSelect.value = 'pending_review';
                    }
                }
            }
            renderKnowledgeList();
        }

        // æ›´æ–°showMainAppå‡½æ•°
        const originalShowMainApp = showMainApp;
        showMainApp = function() {
            originalShowMainApp();
            updateUIForUserRole();
        };

        // åŠ è½½æ•°æ®çœ‹æ¿
        async function loadDashboard() {
            document.getElementById('dashboard-loading').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/statistics/dashboard`, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayDashboard(result.data);
                } else {
                    alert('åŠ è½½æ•°æ®å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('dashboard-loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
            }
        }

        // æ˜¾ç¤ºæ•°æ®çœ‹æ¿
        function displayDashboard(data) {
            const trend = data.knowledge_trend || {
                knowledge_rate: 0,
                total_knowledge: 0,
                total_comments: 0,
                dates: [],
                knowledge_count: [],
                comment_count: []
            };
            const stats = data.review_statistics;
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">
                    <div style="font-size: 32px; font-weight: bold;">${stats.total_reviews}</div>
                    <div style="font-size: 14px; opacity: 0.9;">æ€»å®¡æŸ¥æ¬¡æ•°</div>
                </div>
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px;">
                    <div style="font-size: 32px; font-weight: bold;">${stats.total_issues}</div>
                    <div style="font-size: 14px; opacity: 0.9;">å‘ç°é—®é¢˜æ•°</div>
                </div>
                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px;">
                    <div style="font-size: 32px; font-weight: bold;">${stats.total_knowledge}</div>
                    <div style="font-size: 14px; opacity: 0.9;">çŸ¥è¯†åº“æ¡ç›®</div>
                </div>
                <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 8px;">
                    <div style="font-size: 32px; font-weight: bold;">${stats.knowledge_reuse_rate}%</div>
                    <div style="font-size: 14px; opacity: 0.9;">çŸ¥è¯†å¤ç”¨ç‡</div>
                </div>
                <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: white; padding: 20px; border-radius: 8px;">
                    <div style="font-size: 32px; font-weight: bold;">${trend.knowledge_rate || 0}%</div>
                    <div style="font-size: 14px; opacity: 0.9;">çŸ¥è¯†æ²‰æ·€ç‡</div>
                </div>
            `;
            
            // æ˜¾ç¤ºé«˜é¢‘é—®é¢˜
            const topIssues = data.top_issues;
            const issuesList = document.getElementById('top-issues-list');
            if (topIssues.length === 0) {
                issuesList.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
            } else {
                issuesList.innerHTML = topIssues.map((issue, index) => {
                    // ç¡®ä¿typeå’Œseverityæ˜¯å®‰å…¨çš„å­—ç¬¦ä¸²
                    const safeType = String(issue.type || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeSeverity = String(issue.severity || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeLabel = String(issue.label || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    
                    return `
                    <div onclick="showIssueDetails('${safeType}', '${safeSeverity}', '${safeLabel}')" style="display: flex; align-items: center; padding: 12px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid ${getSeverityColor(issue.severity)}; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#e9ecef'; this.style.transform='translateX(5px)'" onmouseout="this.style.background='#f8f9fa'; this.style.transform='translateX(0)'">
                        <div style="width: 30px; height: 30px; background: #667eea; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px;">
                            ${index + 1}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333;">${escapeHtml(issue.label)}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">å‡ºç° ${issue.count} æ¬¡ - ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                        </div>
                        <div style="color: #667eea; font-size: 20px;">â†’</div>
                    </div>
                `;
                }).join('');
            }
            
            // æ˜¾ç¤ºçŸ¥è¯†æ²‰æ·€è¶‹åŠ¿
            document.getElementById('knowledge-rate').textContent = trend.knowledge_rate;
            document.getElementById('total-knowledge').textContent = trend.total_knowledge;
            document.getElementById('total-comments').textContent = trend.total_comments;
            const rateBar = document.getElementById('knowledge-rate-progress');
            if (rateBar) {
                const width = Math.min(100, Number(trend.knowledge_rate) || 0);
                rateBar.style.width = `${width}%`;
            }
            const reuseChip = document.getElementById('reuse-rate-chip');
            if (reuseChip) {
                reuseChip.textContent = `${stats.knowledge_reuse_rate}%`;
            }
            
            // ç»˜åˆ¶è¶‹åŠ¿å›¾ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
            drawTrendChart(trend);
            
            // æ˜¾ç¤ºå®¡æŸ¥ç»Ÿè®¡
            const reviewStats = document.getElementById('review-stats-content');
            reviewStats.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#e9ecef'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#f8f9fa'; this.style.transform='scale(1)'">
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.total_files}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">å®¡æŸ¥æ–‡ä»¶æ•°</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 6px;">
                        <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${Math.round(stats.avg_review_time_ms)}ms</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">å¹³å‡å®¡æŸ¥æ—¶é—´</div>
                    </div>
                    <div onclick="showSeverityIssues('high', 'é«˜ä¸¥é‡åº¦é—®é¢˜')" style="padding: 15px; background: #f8f9fa; border-radius: 6px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#e9ecef'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#f8f9fa'; this.style.transform='scale(1)'">
                        <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${stats.severity_distribution.high}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">é«˜ä¸¥é‡åº¦é—®é¢˜ - ç‚¹å‡»æŸ¥çœ‹</div>
                    </div>
                    <div onclick="showSeverityIssues('medium', 'ä¸­ä¸¥é‡åº¦é—®é¢˜')" style="padding: 15px; background: #f8f9fa; border-radius: 6px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#e9ecef'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#f8f9fa'; this.style.transform='scale(1)'">
                        <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${stats.severity_distribution.medium}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">ä¸­ä¸¥é‡åº¦é—®é¢˜ - ç‚¹å‡»æŸ¥çœ‹</div>
                    </div>
                    <div onclick="showSeverityIssues('low', 'ä½ä¸¥é‡åº¦é—®é¢˜')" style="padding: 15px; background: #f8f9fa; border-radius: 6px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#e9ecef'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#f8f9fa'; this.style.transform='scale(1)'">
                        <div style="font-size: 24px; font-weight: bold; color: #3498db;">${stats.severity_distribution.low}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">ä½ä¸¥é‡åº¦é—®é¢˜ - ç‚¹å‡»æŸ¥çœ‹</div>
                    </div>
                </div>
            `;
        }

        // ç»˜åˆ¶è¶‹åŠ¿å›¾
        function drawTrendChart(trend) {
            const canvas = document.getElementById('trend-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.parentElement.offsetWidth || 800;
            const height = 300;
            canvas.width = width;
            canvas.height = height;
            
            const dates = trend.dates || [];
            const knowledgeData = trend.knowledge_count || [];
            const commentData = trend.comment_count || [];
            
            const padding = 40;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, width, height);
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
            if (dates.length === 0 || (knowledgeData.length === 0 && commentData.length === 0)) {
                ctx.fillStyle = '#999';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®', width / 2, height / 2);
                ctx.textAlign = 'left';
                return;
            }
            
            // è®¡ç®—æœ€å¤§å€¼
            const maxValue = Math.max(
                ...knowledgeData, 
                ...commentData, 
                1
            );
            
            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#dee2e6';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶Yè½´æ ‡ç­¾
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                const value = Math.round(maxValue * (1 - i / 5));
                ctx.fillText(value.toString(), padding - 5, y + 3);
            }
            ctx.textAlign = 'left';
            
            // ç»˜åˆ¶Xè½´æ—¥æœŸæ ‡ç­¾ï¼ˆåªæ˜¾ç¤ºéƒ¨åˆ†æ—¥æœŸï¼Œé¿å…é‡å ï¼‰
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            const labelInterval = Math.max(1, Math.floor(dates.length / 10));
            for (let i = 0; i < dates.length; i += labelInterval) {
                const x = padding + (chartWidth / Math.max(1, dates.length - 1)) * i;
                const dateLabel = dates[i].substring(5); // åªæ˜¾ç¤ºæœˆ-æ—¥
                ctx.save();
                ctx.translate(x, height - padding + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.fillText(dateLabel, 0, 0);
                ctx.restore();
            }
            
            // ç»˜åˆ¶çŸ¥è¯†åº“è¶‹åŠ¿çº¿
            if (knowledgeData.length > 0) {
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.beginPath();
                const step = dates.length > 1 ? chartWidth / Math.max(1, dates.length - 1) : 0;
                for (let i = 0; i < dates.length; i++) {
                    const x = padding + step * i;
                    const y = height - padding - (knowledgeData[i] / maxValue) * chartHeight;
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
                
                // ç»˜åˆ¶æ•°æ®ç‚¹
                ctx.fillStyle = '#667eea';
                for (let i = 0; i < dates.length; i++) {
                    const x = padding + step * i;
                    const y = height - padding - (knowledgeData[i] / maxValue) * chartHeight;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // ç»˜åˆ¶å®¡æŸ¥è¯„è®ºè¶‹åŠ¿çº¿
            if (commentData.length > 0) {
                ctx.strokeStyle = '#f39c12';
                ctx.lineWidth = 2;
                ctx.beginPath();
                const step = dates.length > 1 ? chartWidth / Math.max(1, dates.length - 1) : 0;
                for (let i = 0; i < dates.length; i++) {
                    const x = padding + step * i;
                    const y = height - padding - (commentData[i] / maxValue) * chartHeight;
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
                
                // ç»˜åˆ¶æ•°æ®ç‚¹
                ctx.fillStyle = '#f39c12';
                for (let i = 0; i < dates.length; i++) {
                    const x = padding + step * i;
                    const y = height - padding - (commentData[i] / maxValue) * chartHeight;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // ç»˜åˆ¶å›¾ä¾‹
            ctx.fillStyle = '#667eea';
            ctx.fillRect(width - 150, 20, 15, 15);
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.fillText('çŸ¥è¯†åº“', width - 130, 32);
            
            ctx.fillStyle = '#f39c12';
            ctx.fillRect(width - 150, 40, 15, 15);
            ctx.fillStyle = '#333';
            ctx.fillText('å®¡æŸ¥è¯„è®º', width - 130, 52);
        }

        function getSeverityColor(severity) {
            const colors = {
                'high': '#e74c3c',
                'medium': '#f39c12',
                'low': '#3498db'
            };
            return colors[severity] || '#667eea';
        }

        // æ™ºèƒ½è¿½é—®åŠŸèƒ½
        function showChatDialog(reviewId, context) {
            const question = prompt('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼š');
            if (!question || !question.trim()) return;
            
            fetch(`${API_BASE}/chat`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    question: question,
                    context: context,
                    review_id: reviewId
                })
            })
            .then(response => {
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    alert(`AIå›ç­”ï¼š\n\n${result.data.answer}`);
                } else {
                    alert('æé—®å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            });
        }

        // æ˜¾ç¤ºé—®é¢˜è¯¦æƒ…
        async function showIssueDetails(issueType, severity, label) {
            try {
                // æ¸…ç†å‚æ•°
                issueType = (issueType || '').trim();
                severity = (severity || '').trim();
                
                if (!issueType || !severity) {
                    alert('å‚æ•°é”™è¯¯ï¼šé—®é¢˜ç±»å‹æˆ–ä¸¥é‡åº¦ä¸èƒ½ä¸ºç©º');
                    return;
                }
                
                // å¦‚æœissueTypeåŒ…å«æ–œæ ï¼Œåªå–ç¬¬ä¸€éƒ¨åˆ†
                if (issueType.includes('/')) {
                    issueType = issueType.split('/')[0];
                }
                
                const url = `${API_BASE}/statistics/issue-details?issue_type=${encodeURIComponent(issueType)}&severity=${encodeURIComponent(severity)}&limit=20`;
                console.log('è¯·æ±‚URL:', url);
                
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('è¯·æ±‚å¤±è´¥:', response.status, errorText);
                    alert(`åŠ è½½è¯¦æƒ…å¤±è´¥: HTTP ${response.status}`);
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.data && result.data.length > 0) {
                        showModal(label, result.data.map(item => ({
                            title: item.comment_text ? (item.comment_text.substring(0, 100) + (item.comment_text.length > 100 ? '...' : '')) : 'æ— æ ‡é¢˜',
                            content: item.comment_text || 'æ— å†…å®¹',
                            code: item.code_snippet || '',
                            date: item.review_date,
                            type: item.comment_type || 'general'
                        })));
                    } else {
                        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæä¾›æ›´è¯¦ç»†çš„æç¤º
                        console.log('æŸ¥è¯¢å‚æ•°:', { issueType, severity });
                        console.log('APIå“åº”:', result);
                        alert(`è¯¥ç±»å‹çš„é—®é¢˜æš‚æ— è¯¦æƒ…æ•°æ®\n\né—®é¢˜ç±»å‹: ${issueType}\nä¸¥é‡åº¦: ${severity}\n\næç¤º: å¯èƒ½è¯¥ç±»å‹çš„é—®é¢˜è¿˜æ²¡æœ‰å®¡æŸ¥è¯„è®ºè®°å½•ï¼Œæˆ–è€…æ•°æ®å·²è¢«æ¸…ç†ã€‚`);
                    }
                } else {
                    alert('åŠ è½½è¯¦æƒ…å¤±è´¥: ' + (result.message || result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('è¯·æ±‚å¼‚å¸¸:', error);
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºä¸¥é‡åº¦é—®é¢˜åˆ—è¡¨
        async function showSeverityIssues(severity, title) {
            try {
                severity = (severity || '').trim();
                
                if (!severity) {
                    alert('å‚æ•°é”™è¯¯ï¼šä¸¥é‡åº¦ä¸èƒ½ä¸ºç©º');
                    return;
                }
                
                const url = `${API_BASE}/statistics/severity-issues?severity=${encodeURIComponent(severity)}&limit=20`;
                console.log('è¯·æ±‚URL:', url);
                
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('è¯·æ±‚å¤±è´¥:', response.status, errorText);
                    alert(`åŠ è½½è¯¦æƒ…å¤±è´¥: HTTP ${response.status}`);
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.data && result.data.length > 0) {
                        showModal(title, result.data.map(item => ({
                            title: `${getTypeName(item.comment_type || 'general')} - ${item.comment_text ? (item.comment_text.substring(0, 80) + (item.comment_text.length > 80 ? '...' : '')) : 'æ— æ ‡é¢˜'}`,
                            content: item.comment_text || 'æ— å†…å®¹',
                            code: item.code_snippet || '',
                            date: item.review_date,
                            type: item.comment_type
                        })));
                    } else {
                        alert('è¯¥ä¸¥é‡åº¦çš„é—®é¢˜æš‚æ— æ•°æ®');
                    }
                } else {
                    alert('åŠ è½½è¯¦æƒ…å¤±è´¥: ' + (result.message || result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('è¯·æ±‚å¼‚å¸¸:', error);
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(title, items) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'detail-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; border-radius: 12px; padding: 30px; max-width: 800px; max-height: 80vh; overflow-y: auto; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);';
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #333;">${title}</h3>
                    <button onclick="document.getElementById('detail-modal').remove()" style="background: #e74c3c; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-size: 14px;">å…³é—­</button>
                </div>
                <div style="max-height: 60vh; overflow-y: auto;">
                    ${items.length === 0 ? '<div class="empty-state">æš‚æ— æ•°æ®</div>' : items.map((item, index) => `
                        <div style="padding: 15px; margin-bottom: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <strong style="color: #333;">#${index + 1}</strong>
                                ${item.date ? `<span style="font-size: 12px; color: #666;">${new Date(item.date).toLocaleDateString()}</span>` : ''}
                            </div>
                            <div style="color: #555; line-height: 1.6; margin-bottom: 10px;">${escapeHtml(item.content)}</div>
                            ${item.code ? `<pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px; overflow-x: auto; margin-top: 10px;">${escapeHtml(item.code)}</pre>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
    </script>
</body>
</html>

